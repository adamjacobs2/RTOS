// multimod_ST7789.c
// Date Created: 2023-07-25
// Date Updated: 2023-07-27
// Defines for ST7789 TFT display

/************************************Includes***************************************/

#include "../multimod_ST7789.h"

#include "../multimod_spi.h"
#include "../../G8RTOS/G8RTOS_Structures.h"

#include <inc/tm4c123gh6pm.h>
#include <inc/hw_types.h>
#include <inc/hw_memmap.h>
#include <inc/hw_ssi.h>
#include <inc/hw_gpio.h>

#include <driverlib/gpio.h>
#include <driverlib/sysctl.h>
#include <driverlib/uart.h>
#include <driverlib/pin_map.h>
#include "../GFX_Library.h"

#include "../../sprites.c"
static const uint8_t font[256][5] = {
   0x00, 0x00, 0x00, 0x00, 0x00,
   0x3E, 0x5B, 0x4F, 0x5B, 0x3E,
   0x3E, 0x6B, 0x4F, 0x6B, 0x3E,
   0x1C, 0x3E, 0x7C, 0x3E, 0x1C,
   0x18, 0x3C, 0x7E, 0x3C, 0x18,
   0x1C, 0x57, 0x7D, 0x57, 0x1C,
   0x1C, 0x5E, 0x7F, 0x5E, 0x1C,
   0x00, 0x18, 0x3C, 0x18, 0x00,
   0xFF, 0xE7, 0xC3, 0xE7, 0xFF,
   0x00, 0x18, 0x24, 0x18, 0x00,
   0xFF, 0xE7, 0xDB, 0xE7, 0xFF,
   0x30, 0x48, 0x3A, 0x06, 0x0E,
   0x26, 0x29, 0x79, 0x29, 0x26,
   0x40, 0x7F, 0x05, 0x05, 0x07,
   0x40, 0x7F, 0x05, 0x25, 0x3F,
   0x5A, 0x3C, 0xE7, 0x3C, 0x5A,
   0x7F, 0x3E, 0x1C, 0x1C, 0x08,
   0x08, 0x1C, 0x1C, 0x3E, 0x7F,
   0x14, 0x22, 0x7F, 0x22, 0x14,
   0x5F, 0x5F, 0x00, 0x5F, 0x5F,
   0x06, 0x09, 0x7F, 0x01, 0x7F,
   0x00, 0x66, 0x89, 0x95, 0x6A,
   0x60, 0x60, 0x60, 0x60, 0x60,
   0x94, 0xA2, 0xFF, 0xA2, 0x94,
   0x08, 0x04, 0x7E, 0x04, 0x08,
   0x10, 0x20, 0x7E, 0x20, 0x10,
   0x08, 0x08, 0x2A, 0x1C, 0x08,
   0x08, 0x1C, 0x2A, 0x08, 0x08,
   0x1E, 0x10, 0x10, 0x10, 0x10,
   0x0C, 0x1E, 0x0C, 0x1E, 0x0C,
   0x30, 0x38, 0x3E, 0x38, 0x30,
   0x06, 0x0E, 0x3E, 0x0E, 0x06,
   0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x5F, 0x00, 0x00,
   0x00, 0x07, 0x00, 0x07, 0x00,
   0x14, 0x7F, 0x14, 0x7F, 0x14,
   0x24, 0x2A, 0x7F, 0x2A, 0x12,
   0x23, 0x13, 0x08, 0x64, 0x62,
   0x36, 0x49, 0x56, 0x20, 0x50,
   0x00, 0x08, 0x07, 0x03, 0x00,
   0x00, 0x1C, 0x22, 0x41, 0x00,
   0x00, 0x41, 0x22, 0x1C, 0x00,
   0x2A, 0x1C, 0x7F, 0x1C, 0x2A,
   0x08, 0x08, 0x3E, 0x08, 0x08,
   0x00, 0x80, 0x70, 0x30, 0x00,
   0x08, 0x08, 0x08, 0x08, 0x08,
   0x00, 0x00, 0x60, 0x60, 0x00,
   0x20, 0x10, 0x08, 0x04, 0x02,
   0x3E, 0x51, 0x49, 0x45, 0x3E,
   0x00, 0x42, 0x7F, 0x40, 0x00,
   0x72, 0x49, 0x49, 0x49, 0x46,
   0x21, 0x41, 0x49, 0x4D, 0x33,
   0x18, 0x14, 0x12, 0x7F, 0x10,
   0x27, 0x45, 0x45, 0x45, 0x39,
   0x3C, 0x4A, 0x49, 0x49, 0x31,
   0x41, 0x21, 0x11, 0x09, 0x07,
   0x36, 0x49, 0x49, 0x49, 0x36,
   0x46, 0x49, 0x49, 0x29, 0x1E,
   0x00, 0x00, 0x14, 0x00, 0x00,
   0x00, 0x40, 0x34, 0x00, 0x00,
   0x00, 0x08, 0x14, 0x22, 0x41,
   0x14, 0x14, 0x14, 0x14, 0x14,
   0x00, 0x41, 0x22, 0x14, 0x08,
   0x02, 0x01, 0x59, 0x09, 0x06,
   0x3E, 0x41, 0x5D, 0x59, 0x4E,
   0x7C, 0x12, 0x11, 0x12, 0x7C,
   0x7F, 0x49, 0x49, 0x49, 0x36,
   0x3E, 0x41, 0x41, 0x41, 0x22,
   0x7F, 0x41, 0x41, 0x41, 0x3E,
   0x7F, 0x49, 0x49, 0x49, 0x41,
   0x7F, 0x09, 0x09, 0x09, 0x01,
   0x3E, 0x41, 0x41, 0x51, 0x73,
   0x7F, 0x08, 0x08, 0x08, 0x7F,
   0x00, 0x41, 0x7F, 0x41, 0x00,
   0x20, 0x40, 0x41, 0x3F, 0x01,
   0x7F, 0x08, 0x14, 0x22, 0x41,
   0x7F, 0x40, 0x40, 0x40, 0x40,
   0x7F, 0x02, 0x1C, 0x02, 0x7F,
   0x7F, 0x04, 0x08, 0x10, 0x7F,
   0x3E, 0x41, 0x41, 0x41, 0x3E,
   0x7F, 0x09, 0x09, 0x09, 0x06,
   0x3E, 0x41, 0x51, 0x21, 0x5E,
   0x7F, 0x09, 0x19, 0x29, 0x46,
   0x26, 0x49, 0x49, 0x49, 0x32,
   0x03, 0x01, 0x7F, 0x01, 0x03,
   0x3F, 0x40, 0x40, 0x40, 0x3F,
   0x1F, 0x20, 0x40, 0x20, 0x1F,
   0x3F, 0x40, 0x38, 0x40, 0x3F,
   0x63, 0x14, 0x08, 0x14, 0x63,
   0x03, 0x04, 0x78, 0x04, 0x03,
   0x61, 0x59, 0x49, 0x4D, 0x43,
   0x00, 0x7F, 0x41, 0x41, 0x41,
   0x02, 0x04, 0x08, 0x10, 0x20,
   0x00, 0x41, 0x41, 0x41, 0x7F,
   0x04, 0x02, 0x01, 0x02, 0x04,
   0x40, 0x40, 0x40, 0x40, 0x40,
   0x00, 0x03, 0x07, 0x08, 0x00,
   0x20, 0x54, 0x54, 0x78, 0x40,
   0x7F, 0x28, 0x44, 0x44, 0x38,
   0x38, 0x44, 0x44, 0x44, 0x28,
   0x38, 0x44, 0x44, 0x28, 0x7F,
   0x38, 0x54, 0x54, 0x54, 0x18,
   0x00, 0x08, 0x7E, 0x09, 0x02,
   0x18, 0xA4, 0xA4, 0x9C, 0x78,
   0x7F, 0x08, 0x04, 0x04, 0x78,
   0x00, 0x44, 0x7D, 0x40, 0x00,
   0x20, 0x40, 0x40, 0x3D, 0x00,
   0x7F, 0x10, 0x28, 0x44, 0x00,
   0x00, 0x41, 0x7F, 0x40, 0x00,
   0x7C, 0x04, 0x78, 0x04, 0x78,
   0x7C, 0x08, 0x04, 0x04, 0x78,
   0x38, 0x44, 0x44, 0x44, 0x38,
   0xFC, 0x18, 0x24, 0x24, 0x18,
   0x18, 0x24, 0x24, 0x18, 0xFC,
   0x7C, 0x08, 0x04, 0x04, 0x08,
   0x48, 0x54, 0x54, 0x54, 0x24,
   0x04, 0x04, 0x3F, 0x44, 0x24,
   0x3C, 0x40, 0x40, 0x20, 0x7C,
   0x1C, 0x20, 0x40, 0x20, 0x1C,
   0x3C, 0x40, 0x30, 0x40, 0x3C,
   0x44, 0x28, 0x10, 0x28, 0x44,
   0x4C, 0x90, 0x90, 0x90, 0x7C,
   0x44, 0x64, 0x54, 0x4C, 0x44,
   0x00, 0x08, 0x36, 0x41, 0x00,
   0x00, 0x00, 0x77, 0x00, 0x00,
   0x00, 0x41, 0x36, 0x08, 0x00,
   0x02, 0x01, 0x02, 0x04, 0x02,
   0x3C, 0x26, 0x23, 0x26, 0x3C,
   0x1E, 0xA1, 0xA1, 0x61, 0x12,
   0x3A, 0x40, 0x40, 0x20, 0x7A,
   0x38, 0x54, 0x54, 0x55, 0x59,
   0x21, 0x55, 0x55, 0x79, 0x41,
   0x22, 0x54, 0x54, 0x78, 0x42, // a-umlaut
   0x21, 0x55, 0x54, 0x78, 0x40,
   0x20, 0x54, 0x55, 0x79, 0x40,
   0x0C, 0x1E, 0x52, 0x72, 0x12,
   0x39, 0x55, 0x55, 0x55, 0x59,
   0x39, 0x54, 0x54, 0x54, 0x59,
   0x39, 0x55, 0x54, 0x54, 0x58,
   0x00, 0x00, 0x45, 0x7C, 0x41,
   0x00, 0x02, 0x45, 0x7D, 0x42,
   0x00, 0x01, 0x45, 0x7C, 0x40,
   0x7D, 0x12, 0x11, 0x12, 0x7D, // A-umlaut
   0xF0, 0x28, 0x25, 0x28, 0xF0,
   0x7C, 0x54, 0x55, 0x45, 0x00,
   0x20, 0x54, 0x54, 0x7C, 0x54,
   0x7C, 0x0A, 0x09, 0x7F, 0x49,
   0x32, 0x49, 0x49, 0x49, 0x32,
   0x3A, 0x44, 0x44, 0x44, 0x3A, // o-umlaut
   0x32, 0x4A, 0x48, 0x48, 0x30,
   0x3A, 0x41, 0x41, 0x21, 0x7A,
   0x3A, 0x42, 0x40, 0x20, 0x78,
   0x00, 0x9D, 0xA0, 0xA0, 0x7D,
   0x3D, 0x42, 0x42, 0x42, 0x3D, // O-umlaut
   0x3D, 0x40, 0x40, 0x40, 0x3D,
   0x3C, 0x24, 0xFF, 0x24, 0x24,
   0x48, 0x7E, 0x49, 0x43, 0x66,
   0x2B, 0x2F, 0xFC, 0x2F, 0x2B,
   0xFF, 0x09, 0x29, 0xF6, 0x20,
   0xC0, 0x88, 0x7E, 0x09, 0x03,
   0x20, 0x54, 0x54, 0x79, 0x41,
   0x00, 0x00, 0x44, 0x7D, 0x41,
   0x30, 0x48, 0x48, 0x4A, 0x32,
   0x38, 0x40, 0x40, 0x22, 0x7A,
   0x00, 0x7A, 0x0A, 0x0A, 0x72,
   0x7D, 0x0D, 0x19, 0x31, 0x7D,
   0x26, 0x29, 0x29, 0x2F, 0x28,
   0x26, 0x29, 0x29, 0x29, 0x26,
   0x30, 0x48, 0x4D, 0x40, 0x20,
   0x38, 0x08, 0x08, 0x08, 0x08,
   0x08, 0x08, 0x08, 0x08, 0x38,
   0x2F, 0x10, 0xC8, 0xAC, 0xBA,
   0x2F, 0x10, 0x28, 0x34, 0xFA,
   0x00, 0x00, 0x7B, 0x00, 0x00,
   0x08, 0x14, 0x2A, 0x14, 0x22,
   0x22, 0x14, 0x2A, 0x14, 0x08,
   0x55, 0x00, 0x55, 0x00, 0x55, // #176 (25% block) missing in old code
   0xAA, 0x55, 0xAA, 0x55, 0xAA, // 50% block
   0xFF, 0x55, 0xFF, 0x55, 0xFF, // 75% block
   0x00, 0x00, 0x00, 0xFF, 0x00,
   0x10, 0x10, 0x10, 0xFF, 0x00,
   0x14, 0x14, 0x14, 0xFF, 0x00,
   0x10, 0x10, 0xFF, 0x00, 0xFF,
   0x10, 0x10, 0xF0, 0x10, 0xF0,
   0x14, 0x14, 0x14, 0xFC, 0x00,
   0x14, 0x14, 0xF7, 0x00, 0xFF,
   0x00, 0x00, 0xFF, 0x00, 0xFF,
   0x14, 0x14, 0xF4, 0x04, 0xFC,
   0x14, 0x14, 0x17, 0x10, 0x1F,
   0x10, 0x10, 0x1F, 0x10, 0x1F,
   0x14, 0x14, 0x14, 0x1F, 0x00,
   0x10, 0x10, 0x10, 0xF0, 0x00,
   0x00, 0x00, 0x00, 0x1F, 0x10,
   0x10, 0x10, 0x10, 0x1F, 0x10,
   0x10, 0x10, 0x10, 0xF0, 0x10,
   0x00, 0x00, 0x00, 0xFF, 0x10,
   0x10, 0x10, 0x10, 0x10, 0x10,
   0x10, 0x10, 0x10, 0xFF, 0x10,
   0x00, 0x00, 0x00, 0xFF, 0x14,
   0x00, 0x00, 0xFF, 0x00, 0xFF,
   0x00, 0x00, 0x1F, 0x10, 0x17,
   0x00, 0x00, 0xFC, 0x04, 0xF4,
   0x14, 0x14, 0x17, 0x10, 0x17,
   0x14, 0x14, 0xF4, 0x04, 0xF4,
   0x00, 0x00, 0xFF, 0x00, 0xF7,
   0x14, 0x14, 0x14, 0x14, 0x14,
   0x14, 0x14, 0xF7, 0x00, 0xF7,
   0x14, 0x14, 0x14, 0x17, 0x14,
   0x10, 0x10, 0x1F, 0x10, 0x1F,
   0x14, 0x14, 0x14, 0xF4, 0x14,
   0x10, 0x10, 0xF0, 0x10, 0xF0,
   0x00, 0x00, 0x1F, 0x10, 0x1F,
   0x00, 0x00, 0x00, 0x1F, 0x14,
   0x00, 0x00, 0x00, 0xFC, 0x14,
   0x00, 0x00, 0xF0, 0x10, 0xF0,
   0x10, 0x10, 0xFF, 0x10, 0xFF,
   0x14, 0x14, 0x14, 0xFF, 0x14,
   0x10, 0x10, 0x10, 0x1F, 0x00,
   0x00, 0x00, 0x00, 0xF0, 0x10,
   0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
   0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
   0xFF, 0xFF, 0xFF, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xFF, 0xFF,
   0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
   0x38, 0x44, 0x44, 0x38, 0x44,
   0xFC, 0x4A, 0x4A, 0x4A, 0x34, // sharp-s or beta
   0x7E, 0x02, 0x02, 0x06, 0x06,
   0x02, 0x7E, 0x02, 0x7E, 0x02,
   0x63, 0x55, 0x49, 0x41, 0x63,
   0x38, 0x44, 0x44, 0x3C, 0x04,
   0x40, 0x7E, 0x20, 0x1E, 0x20,
   0x06, 0x02, 0x7E, 0x02, 0x02,
   0x99, 0xA5, 0xE7, 0xA5, 0x99,
   0x1C, 0x2A, 0x49, 0x2A, 0x1C,
   0x4C, 0x72, 0x01, 0x72, 0x4C,
   0x30, 0x4A, 0x4D, 0x4D, 0x30,
   0x30, 0x48, 0x78, 0x48, 0x30,
   0xBC, 0x62, 0x5A, 0x46, 0x3D,
   0x3E, 0x49, 0x49, 0x49, 0x00,
   0x7E, 0x01, 0x01, 0x01, 0x7E,
   0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
   0x44, 0x44, 0x5F, 0x44, 0x44,
   0x40, 0x51, 0x4A, 0x44, 0x40,
   0x40, 0x44, 0x4A, 0x51, 0x40,
   0x00, 0x00, 0xFF, 0x01, 0x03,
   0xE0, 0x80, 0xFF, 0x00, 0x00,
   0x08, 0x08, 0x6B, 0x6B, 0x08,
   0x36, 0x12, 0x36, 0x24, 0x36,
   0x06, 0x0F, 0x09, 0x0F, 0x06,
   0x00, 0x00, 0x18, 0x18, 0x00,
   0x00, 0x00, 0x10, 0x10, 0x00,
   0x30, 0x40, 0xFF, 0x01, 0x01,
   0x00, 0x1F, 0x01, 0x01, 0x1E,
   0x00, 0x19, 0x1D, 0x17, 0x12,
   0x00, 0x3C, 0x3C, 0x3C, 0x3C,
   0x00, 0x00, 0x00, 0x00, 0x00  // #255 NBSP
};
/***********************************Macro Defines***********************************/
#ifndef _swap_int16_t
#define _swap_int16_t(a, b) \
{  \
    int16_t t = a; \
    a = b; \
    b = t; \
}
#endif

/********************************Private Functions**********************************/

// ST7789_Select
// Selects the ST7789 for SPI transmission.
// Return: void
void ST7789_Select(void) {
    GPIOPinWrite(ST7789_PIN_PORT_BASE, ST7789_CS_PIN, 0x00);
}

// ST7789_Deselect
// Deselects the ST7789 for SPI transmission.
// Return: void
void ST7789_Deselect(void) {
    GPIOPinWrite(ST7789_PIN_PORT_BASE, ST7789_CS_PIN, 0xFF);
}

// ST7789_SetData
// Sets the Data/Command pin to data.
// Return: void
void ST7789_SetData(void) {
    GPIOPinWrite(ST7789_PIN_PORT_BASE, ST7789_DC_PIN, 0xFF);
}

// ST7789_SetCommand
// Sets the Data/Command pin to command.
// Return: void
void ST7789_SetCommand(void) {
    GPIOPinWrite(ST7789_PIN_PORT_BASE, ST7789_DC_PIN, 0x00);
}

// ST7789_WriteCommand
// Similar to BMI160, writes to specify which register that data
// will be sent to.
// Param uint8_t "cmd": command register to send data to.
// Return: void
void ST7789_WriteCommand(uint8_t cmd) {
    ST7789_SetCommand();
    SPI_WriteSingle(SPI_A_BASE, cmd);
    ST7789_SetData();
}

// ST7789_WriteData
// Sends data to register specified by CMD.
// Param uint8_t "data": data to be sent.
// Return: void
void ST7789_WriteData(uint8_t data) {
    SPI_WriteSingle(SPI_A_BASE, data);
}

// ST7789_ReadRegister
// Reads from SPI bus.
// Return: uint8_t
uint8_t ST7789_ReadRegister(uint8_t data) {
    return SPI_ReadSingle(SPI_A_BASE);
}

// ST7789_SetWindow
// Sets windows subsequent pixels will be generated at.
// Param int16_t x: x-coord of first corner.
// Param int16_t y: y-coord of first corner.
// Param int16_t w: width of window.
// Param int16_t h: height of window.
// Return: void
void ST7789_SetWindow(int16_t x, int16_t y, int16_t w, int16_t h) {
    // Your code here!

    // Check boundary conditions
    if (x < 0 || y < 0 || w < 0 || h < 0 ||
          x > X_MAX || y > Y_MAX || w  + x > X_MAX || h + y > Y_MAX) {

          return;
      }
    // Set column address

    ST7789_WriteCommand(ST7789_CASET_ADDR);
    ST7789_WriteData(x >> 8 & 0xFF);
    ST7789_WriteData(x >> 0 & 0xFF);
    ST7789_WriteData(((x+w) >> 8 & 0xFF));
    ST7789_WriteData(((x+w) >> 0 & 0xFF));

    // Set row address
    ST7789_WriteCommand(ST7789_RASET_ADDR);
    ST7789_WriteData(y >> 8 & 0xFF);
    ST7789_WriteData(y >> 0 & 0xFF);
    ST7789_WriteData(((y+h) >> 8 & 0xFF));
    ST7789_WriteData(((y+h) >> 0 & 0xFF));

    // Set register to write to as memory
    ST7789_WriteCommand(ST7789_RAMWR_ADDR);

    return;

}

// ST7789_DrawVLine
// Draws a vertical line.
// Param int16_t x: x-coord of first pixel.
// Param int16_t y: y-coord of first pixel.
// Param uint16_t h: height of line.
// Param uint16_t color: color of line.
// Return: void
void ST7789_DrawVLine(uint16_t x, uint16_t y, uint16_t h, uint16_t color)
{
    if ((x < X_MAX) && (y < Y_MAX) && h)
    {
        uint8_t color_hi = color >> 8, color_lo = color;
        if ((y + h - 1) >= Y_MAX)
            h = Y_MAX - y;
        ST7789_Select();
        ST7789_SetWindow(x, y, 1, h);
        while (h--)
        {
            ST7789_WriteData(color_hi);
            ST7789_WriteData(color_lo);
        }

        ST7789_Deselect();
    }
}

// ST7789_DrawHLine
// Draws a horizontal line.
// Param int16_t x: x-coord of first pixel.
// Param int16_t y: y-coord of first pixel.
// Param uint16_t w: width of line.
// Param uint16_t color: color of line.
// Return: void
void ST7789_DrawHLine(uint16_t x, uint16_t y, uint16_t w, uint16_t color) {
    if ((x < X_MAX) && (y < Y_MAX) && w)
    {
        uint8_t color_hi = color >> 8, color_lo = color;

        if ((x >= X_MAX) || (y >= Y_MAX))
            return;
        if ((x + w - 1) >= X_MAX)
            w = X_MAX - x;
        ST7789_Select();
        ST7789_SetWindow(x, y, w, 1);
        while (w--)
        {
            ST7789_WriteData(color_hi);
            ST7789_WriteData(color_lo);
        }

        ST7789_Deselect();
    }
}

// ST7789_Line
// Draws a line from point 1 to point 2.
// Param uint16_t x0: x-coord of first point.
// Param uint16_t y0: y-coord of first point.
// Param uint16_t x1: x-coord of second point.
// Param uint16_t y1: y-coord of second point.
// Param uint16_t color: color of line.
// Return: void
void ST7789_Line(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1, uint16_t color)
{
    bool steep = abs((int16_t)(y1 - y0)) > abs((int16_t)(x1 - x0));
    if (steep)
    {
        _swap_int16_t(x0, y0);
        _swap_int16_t(x1, y1);
    }

    if (x0 > x1)
    {
        _swap_int16_t(x0, x1);
        _swap_int16_t(y0, y1);
    }

    int16_t dx, dy;
    dx = x1 - x0;
    dy = abs((int16_t)(y1 - y0));

    int16_t err = dx / 2;
    int16_t ystep;

    if (y0 < y1)
    {
        ystep = 1;
    }
    else
    {
        ystep = -1;
    }

    for (; x0 <= x1; x0++)
    {
        if (steep)
        {
            ST7789_DrawPixel(y0, x0, color);
        }
        else
        {
            ST7789_DrawPixel(x0, y0, color);
        }

        err -= dy;
        if (err < 0)
        {
            y0 += ystep;
            err += dx;
        }
    }
}




/********************************Public Functions***********************************/

// ST7789_Init
// Initializes the TFT display to begin being able to be drawn to.
// Return: void
void ST7789_Init() {
    SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOF);
    GPIOPinTypeGPIOOutput(ST7789_PIN_PORT_BASE, ST7789_CS_PIN);
    GPIOPinTypeGPIOOutput(ST7789_PIN_PORT_BASE, ST7789_DC_PIN);
    SPI_Init(SPI_A_BASE);
    
    ST7789_Deselect();
    
    // Do software reset first
    ST7789_Select();

    ST7789_WriteCommand(ST7789_SWRESET_ADDR);
    delay_ms(120);
    ST7789_WriteCommand(ST7789_SLPOUT_ADDR);
    delay_ms(500);
    ST7789_WriteCommand(ST7789_COLMOD_ADDR);
    ST7789_WriteData(0x55);

    ST7789_WriteCommand(ST7789_CASET_ADDR);
    ST7789_WriteData(0x00);
    ST7789_WriteData(0x00);
    ST7789_WriteData((X_MAX >> 8 & 0xFF));
    ST7789_WriteData((X_MAX >> 0 & 0xFF));

    ST7789_WriteCommand(ST7789_RASET_ADDR);
    ST7789_WriteData(0x00);
    ST7789_WriteData(0x00);
    ST7789_WriteData((Y_MAX >> 8 & 0xFF));
    ST7789_WriteData((Y_MAX >> 0 & 0xFF));

    ST7789_WriteCommand(ST7789_RASET_ADDR);
    ST7789_WriteData(0x00);
    ST7789_WriteData(0x00);
    ST7789_WriteData((Y_MAX >> 8 & 0xFF));
    ST7789_WriteData((Y_MAX >> 0 & 0xFF));

    // set column address order right to left, line address order bottom to top
    ST7789_WriteCommand(ST7789_MADCTL_ADDR);
    ST7789_WriteData(0b01001000);

    ST7789_WriteCommand(ST7789_NORON_ADDR);
    delay_ms(120);

    ST7789_WriteCommand(ST7789_INVON_ADDR);
    delay_ms(120);

    ST7789_WriteCommand(ST7789_DISPON_ADDR);
    delay_ms(120);
    ST7789_Fill(0x0000);
    ST7789_Deselect();
}

// ST7789_DrawPixel
// Draws a pixel of color at x, y.
// Param uint16_t "x": x-axis of pixel.
// Param uint16_t "y": y-axis of pixel.
// Param uint16_t "color": color of pixel.
// Return: void
void ST7789_DrawPixel(uint16_t x, uint16_t y, uint16_t color) {
    // Check boundary conditions
        // Set window
        ST7789_Select();
        ST7789_SetWindow(x, y, 1, 1);
        int8_t color_hi = color >> 8;
        int8_t color_lo = color & 0xFF;
        ST7789_WriteData(color_hi);
        ST7789_WriteData(color_lo);

        ST7789_WriteCommand(ST7789_RAMWR_ADDR);
        ST7789_Select();


        // Set color
        return;
}

// ST7789_DrawPixel
// Fills screen with color.
// Param uint16_t "color": color of fill.
// Return: void
void ST7789_Fill(uint16_t color) {
    ST7789_DrawRectangle(0, 0, X_MAX, Y_MAX, color);
}

// ST7789_DrawLine
// Draws a line from point 1 to point 2.
// Param uint16_t x0: x-coord of first point.
// Param uint16_t y0: y-coord of first point.
// Param uint16_t x1: x-coord of second point.
// Param uint16_t y1: y-coord of second point.
// Param uint16_t color: color of line.
// Return: void
void ST7789_DrawLine(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1, uint16_t color) {
    // Update in subclasses if desired!
    if (x0 == x1) {
        if (y0 > y1) _swap_int16_t(y0, y1);
        ST7789_DrawVLine(x0, y0, y1 - y0 + 1, color);
    } else if (y0 == y1) {
        if (x0 > x1) _swap_int16_t(x0, x1);
        ST7789_DrawHLine(x0, y0, x1 - x0 + 1, color);
    } else {
        ST7789_Line(x0, y0, x1, y1, color);
    }
}

// ST7789_DrawRectangle
// Draws a rectangle.
// Param uint16_t x: x-coord of first point.
// Param uint16_t y: y-coord of first point.
// Param uint16_t w: width of rectangle
// Param uint16_t h: height of retangle.
// Param uint16_t color: color of line.
// Return: void
void ST7789_DrawRectangle(uint16_t x, uint16_t y, uint16_t w, uint16_t h, uint16_t color) {
    uint8_t color_hi, color_lo;
    ST7789_Select();
    ST7789_SetWindow(x, y, w, h);

    color_hi = color >> 8;
    color_lo = color & 0xFF;

    uint32_t num_p = (uint32_t)w * (uint32_t)h;
    while (num_p--) {
        ST7789_WriteData(color_hi);
        ST7789_WriteData(color_lo);
    }
    ST7789_Deselect();
}
void ST7789_DrawRow(position_t row, uint8_t hole, uint16_t color) {
    //draw the new pixels in each row
        ST7789_SetWindow(0, row.y, hole, 1); //TODO: Account for faster levels
        uint8_t color_hi = color >> 8;
        uint8_t color_lo = color & 0xFF;
        uint32_t num_p = hole;
        while (num_p--) {
            ST7789_WriteData(color_hi);
            ST7789_WriteData(color_lo);
        }

        ST7789_SetWindow(hole + 40, row.y, 200 - hole, 1); //TODO: Account for faster levels
        color_hi = color >> 8;
        color_lo = color & 0xFF;
        num_p = (200 - hole) * 1;
        while (num_p--) {
            ST7789_WriteData(color_hi);
            ST7789_WriteData(color_lo);
         }
}

void ST7789_ClearRow(position_t row) {
    //draws the the rows pixels partially black (bottom sliver)
      ST7789_SetWindow(row.x, row.y, 240, 1); //TODO: Account for faster levels

      uint32_t num_p = 240;
      while (num_p--) {
          ST7789_WriteData(0); //black
          ST7789_WriteData(0);
      }
}

void ST7789_DrawSprite(position_t location, const uint16_t pixels[], uint16_t size){
    ST7789_SetWindow(location.x, location.y, size, size);
    uint16_t num_p = size * size;

    for(uint8_t i = 0; i < num_p; i++){
        ST7789_WriteData(pixels[i] >> 8);
        ST7789_WriteData(pixels[i] & 0xFF);
    }
}

//This function Will be called in a periodic thread that will update the game at a rate of 60 Hz
void ST7789_UpdateScreen(gameData_t gameNew, gameData_t gamePrev, uint16_t rowColor) {
    ST7789_Select();

    //draws the balls previous position black
     ST7789_SetWindow(gamePrev.ball.x, gamePrev.ball.y,15, 15);



    uint32_t num_p = 225; //225 pixel ball
    while (num_p--){

        ST7789_WriteData(0); //black
        ST7789_WriteData(0);
    }



    ST7789_ClearRow(gamePrev.rows[0]);
    ST7789_ClearRow(gamePrev.rows[1]);
    ST7789_ClearRow(gamePrev.rows[2]);
    ST7789_ClearRow(gamePrev.rows[3]);
    ST7789_ClearRow(gamePrev.rows[4]);


    ST7789_DrawRow(gameNew.rows[0], gameNew.rows[0].hole, rowColor);
    ST7789_DrawRow(gameNew.rows[1], gameNew.rows[1].hole, rowColor);
    ST7789_DrawRow(gameNew.rows[2], gameNew.rows[2].hole, rowColor);
    ST7789_DrawRow(gameNew.rows[3], gameNew.rows[3].hole, rowColor);
    ST7789_DrawRow(gameNew.rows[4], gameNew.rows[4].hole, rowColor);






    ST7789_SetWindow(200, 200, 10, 10);

    //draws the balls new position white
    ST7789_SetWindow(gameNew.ball.x, gameNew.ball.y, 15, 15);

    num_p = 225; //400 pixel ball
    while (num_p--) {
        ST7789_WriteData(0xFF); //white
        ST7789_WriteData(0xFF);
     }



    ST7789_Deselect();
}

